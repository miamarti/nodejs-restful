#!/usr/bin/node

/**
 * Ensures all the indexes!
 * Add a `indexes.js` folder to every folder in lib.
 */

var assert = require('assert')
var path = require('path')
var fs = require('fs')

var lib = require.resolve('../lib')

require('../lib/databases/mongodb').then(function () {
  var promises = []

  fs.readFileSync(lib).forEach(function (name) {
    var folder = path.join(lib, name)
    if (!fs.statSync(folder).isDirectory()) return
    var indexes = path.join(folder, 'indexes')
    if (!fs.existsSync(indexes)) return
    arr = require('../lib/' + name + '/indexes')
    assert(Array.isArray(arr))
    promises.push(arr)
  })

  return Promise.all(promises.reduce(function (a, b) {
    return a.concat(b)
  }, []))
}).then(function () {
  console.log('Ensured all indexes!')
  process.exit(0)
}).catch(function (err) {
  console.error('Failed ensuring indexes!')
  console.error(err.stack)
  process.exit(1)
})
