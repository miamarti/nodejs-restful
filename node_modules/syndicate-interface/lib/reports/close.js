
var assert = require('http-assert')

var mdb = require('../databases/mongodb')
var redis = require('../databases/redis')

module.exports = function* (report, closer) {
  var thing = report.thing
  assert(closer, 401)
  assert(closer._id)
  assert(thing._id)
  assert(thing.collection)

  // TODO: make sure that it's actually closed
  var a = mdb.reports.findOne('_id', report._id).set({
    closed: true,
    'date.closed': new Date(),
    'closer._id': closer._id
  })

  var b = redis.zincrby('reports', -1, thing.collection + ':' + thing._id.toHexString())

  yield [a, b]
}
