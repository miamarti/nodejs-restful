
var mdb = require('../databases/mongodb')
var redis = require('../databases/redis')
var syndicate = require('../syndicate')
var Report = require('../report')

module.exports = function* (obj) {
  var thing = obj.thing
  var report = new Report()
  Report.set.relation(report, 'thing', thing)
  Report.set.relation(report, 'creator', obj.creator)
  yield Report.set.markdown(report, obj.markdown)
  yield mdb.reports.insert(report)
  yield redis.zincrby('reports', 1, thing.collection + ':' + thing._id.toHexString())
  yield mdb.collection(thing.collection).find('_id', thing._id).inc('count.reports', 1)
  syndicate.emit('report', report)
  return report
}
